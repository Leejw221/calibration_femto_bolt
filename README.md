# Femto Bolt 카메라 캘리브레이션 시스템

Orbbec Femto Bolt 카메라의 Depth-to-Checkerboard 좌표 변환을 위한 완전 자동화된 캘리브레이션 및 실시간 시각화 시스템입니다.

## 📁 파일 구조 및 역할

### 🔧 핵심 스크립트
- **`calibration_by_sdk.py`** - 메인 캘리브레이션 스크립트
  - 9x6 체커보드 패턴 인식
  - SDK 내장 파라미터 활용
  - solvePnP 기반 좌표 변환 계산
  - 여러 PnP 방법 자동 테스트
  - 재투영 오차 최적화

- **`open3d_visualization.py`** - 실시간 포인트 클라우드 시각화
  - 캘리브레이션 결과 자동 로드
  - Open3D 기반 3D 시각화
  - 체커보드 및 카메라 좌표계 표시
  - ESC 키로 종료

- **`calibration_utils.py`** - 공통 유틸리티 함수
  - 최신 캘리브레이션 결과 로드
  - 백업 파일 관리
  - 실수 표기법 행렬 출력

- **`utils.py`** - 기본 유틸리티
  - 프레임-이미지 변환 함수

### 🚀 자동화 스크립트
- **`calibration_and_visualization.sh`** - 원클릭 실행 스크립트
  - 캘리브레이션 → 시각화 자동 연결
  - 결과 요약 출력
  - 오류 처리 및 안내

### 📊 데이터 파일
- **`depth_to_checkerboard_transform.txt`** - 최신 4x4 변환 행렬
- **`latest_calibration_info.json`** - 상세 캘리브레이션 정보
- **`calibration_log.txt`** - 캘리브레이션 히스토리

### 🔧 SDK 파일
- **`libOrbbecSDK.so*`** - Orbbec SDK 라이브러리
- **`pyorbbecsdk.cpython-*.so`** - Python SDK 바인딩
- **`OrbbecSDKConfig.xml`** - SDK 설정 파일
- **`pyorbbecsdk/`** - SDK 소스 및 예제
- **`extensions/`** - SDK 확장 라이브러리

## 🎯 사용 방법

### 방법 1: 원클릭 실행 (권장)
```bash
cd /home/leejungwook/Femto_bolt_calibration
./calibration_and_visualization.sh
```

### 방법 2: 개별 실행
```bash
# 1. 캘리브레이션만 실행
python3 calibration_by_sdk.py

# 2. 시각화만 실행 (캘리브레이션 완료 후)
python3 open3d_visualization.py

# 3. 캘리브레이션 결과 확인
python3 calibration_utils.py
```

## ⚙️ 시스템 설정

### 해상도 설정
- **캘리브레이션**: Color 1280x720, Depth 320x288 (시각화와 동일)
- **시각화**: Color 1280x720, Depth 320x288
- **Fallback**: SDK 기본 해상도 사용 (지정 해상도 실패 시)

### 카메라 설치
- 카메라는 데스크 위에 설치되어 있으며 기울기는 자동으로 보정됨
- 체커보드는 데스크 평면에 수평으로 배치해야 함
- 시스템이 자동으로 좌표 변환을 처리함

## 📋 캘리브레이션 절차

### 1. 체커보드 준비
- **패턴**: 9x6 교차점 (10x7 사각형)
- **크기**: 55mm 사각형
- **재질**: 평평한 종이 또는 플라스틱

### 2. 카메라 설정
- **설치**: 데스크에 설치 (기울기는 자동 보정됨)
- **해상도**: Color 1280x720, Depth 320x288 (시각화와 동일)
- **거리**: 체커보드가 화면에 적당히 보이는 거리

### 3. 캘리브레이션 과정
1. **체커보드 배치**: 책상에 평평하게 놓기
2. **인식 확인**: 컬러 라인이 그려지면 인식 성공
3. **품질 확인**: 70% 이상일 때 진행
4. **캘리브레이션**: SPACE 키 누르기
5. **완료**: 자동으로 시각화 시작

### 4. 조작 방법
- **캘리브레이션 창**:
  - `SPACE`: 캘리브레이션 실행
  - `q`: 종료
- **시각화 창**:
  - `ESC`: 종료
  - 마우스: 시점 조작

## 🎨 좌표계 정의

### 체커보드 좌표계
- **원점**: 맨위, 맨왼쪽 교차점 (시각화 기준)
- **X축**: 오른쪽 방향 (빨간색)
- **Y축**: 아래쪽 방향 (초록색)
- **Z축**: 체커보드 평면에서 위쪽 (파란색)

### 시각화 요소
- **큰 좌표축**: 체커보드 원점 (크기 150mm)
- **작은 좌표축**: 카메라 위치 (크기 75mm)
- **포인트 클라우드**: 실시간 3D 점들

## 📈 캘리브레이션 품질

### 품질 지표
- **재투영 오차**: < 1.0px (우수), < 0.5px (매우 우수)
- **검출 품질**: 70% 이상 권장
- **회전 행렬**: determinant = 1.0

### 결과 파일
```
변환 행렬 예시:
[ 0.994144  0.001478  0.026562 -280.048950]
[-0.016698  0.808585  0.588139 -114.991554]
[-0.020528 -0.588378  0.808323  656.504900]
[ 0.000000  0.000000  0.000000   1.000000]
```

## 🔧 문제 해결

### 체커보드 인식 안됨
- 조명 개선
- 체커보드 평평하게 배치
- 카메라와의 거리 조정
- 체커보드 크기 확인 (9x6 교차점)

### 캘리브레이션 품질 낮음
- 체커보드를 이미지 중앙에 배치
- 여러 각도에서 시도
- 체커보드 표면 평평하게 유지

### 시각화 창 문제
- ESC 키로 종료
- GPU 드라이버 확인
- Open3D 라이브러리 재설치

## 📚 기술적 세부사항

### 캘리브레이션 알고리즘
1. **SDK 파라미터 추출**: `get_intrinsic()`, `get_extrinsic_to()`
2. **체커보드 검출**: OpenCV `findChessboardCorners`
3. **PnP 해법**: ITERATIVE, EPNP, P3P, SQPNP 중 최적 선택
4. **좌표 변환**: Depth → Color → Checkerboard

### 정확도 향상 기법
- 서브픽셀 정확도 (`cornerSubPix`)
- 이미지 전처리 (CLAHE, 가우시안 블러)
- 다중 PnP 방법 테스트
- 재투영 오차 최소화

## 🚀 시스템 요구사항

### 하드웨어
- Orbbec Femto Bolt 카메라
- Ubuntu 20.04+ (또는 호환 Linux)
- USB 3.0 포트

### 소프트웨어
- Python 3.8+
- OpenCV 4.5+
- Open3D 0.15+
- NumPy 1.20+
- Orbbec SDK 2.4.8+

---

**개발자**: GitHub Copilot  
**버전**: 1.0  
**날짜**: 2025년 8월 12일
